name: Release

on:
  push:
    branches:
      - master

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2
        with:
          fetch-depth: 0

      - name: Generate release tag
        id: tag
        run: |
          TAG="$(date +%Y.%m.%d)-$(git rev-parse --short HEAD)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Setup APE support
        run: |
          sudo cp build/bootstrap/ape.elf /usr/bin/ape
          sudo sh -c "echo ':APE:M::MZqFpD::/usr/bin/ape:' >/proc/sys/fs/binfmt_misc/register"

      - name: Build utilities
        run: |
          make -j$(nproc) MODE=rel \
            o/rel/third_party/make/make.dbg \
            o/rel/third_party/zip/zip.dbg \
            o/rel/third_party/unzip/unzip.dbg \
            o/rel/tool/lua/lua.dbg \
            o/rel/tool/lua/test

      - name: Prepare utilities
        run: |
          mkdir -p release/bin
          objcopy -S -O binary o/rel/third_party/make/make.dbg release/bin/make
          objcopy -S -O binary o/rel/third_party/zip/zip.dbg release/bin/zip
          objcopy -S -O binary o/rel/third_party/unzip/unzip.dbg release/bin/unzip
          objcopy -S -O binary o/rel/tool/lua/lua.dbg release/bin/lua
          chmod +x release/bin/*

      - name: Build cosmocc
        run: tool/cosmocc/package.sh cosmocc-build

      - name: Package cosmocc
        run: |
          cd cosmocc-build
          zip -ry9 ../cosmocc.zip .
          cd ..

      - name: Create checksums
        run: |
          cd release/bin
          sha256sum make zip unzip lua > SHA256SUMS
          cd ../..
          sha256sum cosmocc.zip >> release/bin/SHA256SUMS

      - name: Create release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.2.0
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          files: |
            cosmocc.zip
            release/bin/make
            release/bin/zip
            release/bin/unzip
            release/bin/lua
            release/bin/SHA256SUMS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
