name: Release

on:
  push:
    branches:
      - master

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2
        with:
          fetch-depth: 0

      - name: Generate release tag
        id: tag
        run: |
          TAG="$(date +%Y.%m.%d)-$(git rev-parse --short HEAD)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Setup APE support
        run: |
          sudo cp build/bootstrap/ape.elf /usr/bin/ape
          sudo sh -c "echo ':APE:M::MZqFpD::/usr/bin/ape:' >/proc/sys/fs/binfmt_misc/register"

      - name: Build x86_64 binaries
        run: |
          make -j$(nproc) m=x86_64 \
            o/x86_64/ape/ape.elf \
            o/x86_64/tool/build/apelink.dbg \
            o/x86_64/tool/lua/lua.dbg \
            o/x86_64/tool/lua/test \
            o/x86_64/third_party/make/make.dbg \
            o/x86_64/third_party/zip/zip.dbg \
            o/x86_64/third_party/unzip/unzip.dbg

      - name: Build aarch64 binaries
        run: |
          make -j$(nproc) m=aarch64 \
            o/aarch64/ape/ape.elf \
            o/aarch64/tool/lua/lua.dbg \
            o/aarch64/third_party/make/make.dbg \
            o/aarch64/third_party/zip/zip.dbg \
            o/aarch64/third_party/unzip/unzip.dbg

      - name: Create fat APE binaries
        run: |
          mkdir -p o/fat/bin
          o/x86_64/tool/build/apelink.dbg -s \
            -l o/x86_64/ape/ape.elf \
            -l o/aarch64/ape/ape.elf \
            -M ape/ape-m1.c \
            -o o/fat/bin/lua \
            o/x86_64/tool/lua/lua.dbg \
            o/aarch64/tool/lua/lua.dbg
          for bin in make zip unzip; do
            o/x86_64/tool/build/apelink.dbg -s \
              -l o/x86_64/ape/ape.elf \
              -l o/aarch64/ape/ape.elf \
              -M ape/ape-m1.c \
              -o o/fat/bin/$bin \
              o/x86_64/third_party/$bin/$bin.dbg \
              o/aarch64/third_party/$bin/$bin.dbg
          done

      - name: Verify fat binaries
        run: |
          for bin in lua make zip unzip; do
            grep -q MZqFpD o/fat/bin/$bin
          done
          o/fat/bin/lua -v
          o/fat/bin/make --version
          o/fat/bin/zip -v
          o/fat/bin/unzip -v

      - name: Create checksums
        run: |
          cd o/fat/bin
          sha256sum make zip unzip lua > SHA256SUMS

      - name: Create release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.2.0
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          files: |
            o/fat/bin/make
            o/fat/bin/zip
            o/fat/bin/unzip
            o/fat/bin/lua
            o/fat/bin/SHA256SUMS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f latest
          git push origin latest --force
